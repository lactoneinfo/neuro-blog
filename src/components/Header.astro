---
import { getCollection, type CollectionEntry } from 'astro:content';
import HeaderLink from './HeaderLink.astro';
import { SITE_TITLE, MENU, type MenuItem } from '../consts';

const posts = await getCollection('blog') as CollectionEntry<'blog'>[];
---

<header>
  <h1><HeaderLink href="/">{SITE_TITLE}</HeaderLink></h1>

  {MENU.map(item => (
    <div class="menu-group">
      <p class="category-title">{item.label}</p>

      {item.children?.map(sub => {
        const prefix = sub.path!.split('?')[0].replace(/^\//, '');
		console.log(prefix);
        const list = posts.filter(p => p.id.startsWith(prefix + '/'));

        return (
          <details class="submenu">
            <summary>
              <HeaderLink href={sub.path!}>{sub.label}</HeaderLink>
            </summary>
            {list.length > 0 && (
              <ul>
                {list.map(post => (
                  <li>
                    <HeaderLink href={`/${post.id}`}>
                      {post.data.title}
                    </HeaderLink>
                  </li>
                ))}
              </ul>
            )}
          </details>
        );
      })}

      {/* path しかない単独カテゴリ（例：About） */}
      {item.children === undefined && item.path && (
        <HeaderLink href={item.path} class="single-link">
          {item.label}
        </HeaderLink>
      )}
    </div>
  ))}

  <div class="social">
    <!-- SVG アイコン -->
  </div>
</header>

<style>
header {
  flex: 0 0 240px;
  padding: 1em;
  background: #fff;
  box-shadow: 2px 0 8px rgba(0,0,0,0.05);
  display: flex;
  flex-direction: column;
}
h1 {
  margin: 0 0 1em;
  font-size: 1.25em;
}
.menu-group {
  margin-bottom: 1em;
}
.category-title {
  margin: 0.5em 0 0.25em;
  font-weight: bold;
  color: var(--accent);
}
.submenu {
  margin: 0.25em 0 1em;
}
.submenu > summary {
  cursor: pointer;
  padding: 0.25em 0;
  font-size: 1em;
}
.submenu ul {
  list-style: none;
  margin: 0;
  padding: 0 0 0 1em;
}
.submenu li {
  margin: 0.25em 0;
}
.single-link {
  display: block;
  margin: 0.5em 0 1em;
  color: var(--black);
  text-decoration: none;
}
.social {
  margin-top: auto;
  display: flex;
  gap: 0.5em;
}
.app main {
  margin-left: 240px;
}
</style>
